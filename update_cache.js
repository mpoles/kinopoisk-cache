const fs=require("fs"),axios=require("axios"),{KINOPOISK_API_KEY:e,TMDB_API_KEY:t}=process.env;e&&t||process.exit(1);const kinopoiskAxios=axios.create({headers:{"X-API-KEY":e}}),tmdbAxios=axios.create({headers:{Authorization:`Bearer ${t}`}}),fetchPage=async e=>{try{let{data:t}=await kinopoiskAxios.get(e);return t}catch(s){return console.error("Не удалось получить данные:",e,s.message),null}},fetchMultiplePages=async(e,t)=>{let s=Array.from({length:t},(t,s)=>{let i=e.replace("PAGE",s+1);return fetchPage(i)}),i=await Promise.all(s);return i.reduce((e,t)=>(t?.docs&&e.push(...t.docs),e),[])},fetchCollectionCover=async e=>{let t=`https://api.kinopoisk.dev/v1.4/list?page=1&limit=1&selectFields=cover&slug=${e}`,s=await fetchPage(t);return s?.docs?.[0]?.cover?.url||null},fetchTmdbPosterPath=async(e,t)=>{if(!e)return null;let s=t?"movie":"tv",i=`https://api.themoviedb.org/3/${s}/${e}/images?include_image_language=ru`;try{let{data:{posters:a}}=await tmdbAxios.get(i);return a.length||(i=`https://api.themoviedb.org/3/${s}/${e}/images`,{data:{posters:a}}=await tmdbAxios.get(i)),a.length?a[0].file_path:null}catch(r){return console.error(`Нет постера ID ${e}`,r.message),null}},pLimit=e=>{let t=0,s=[],i=()=>{t--,s.length>0&&s.shift()()};return a=>new Promise((r,l)=>{let n=async()=>{t++;try{let e=await a();r(e)}catch(s){l(s)}finally{i()}};t<e?n():s.push(n)})},limit=pLimit(5),enrichWithTmdbPosters=async(e,t)=>{await Promise.all(e.map(e=>limit(async()=>{if(!e.poster_path){let s=await fetchTmdbPosterPath(e.id,t);s&&(e.poster_path=s)}})))},fetchTmdbDataForMissingIds=async e=>{let t=`https://api.themoviedb.org/3/search/movie?query=${encodeURIComponent(e)}`;try{let{data:s}=await tmdbAxios.get(t),[i]=s.results;return i?{id:i.id,poster_path:i.poster_path}:{id:null,poster_path:null}}catch(a){return console.error(`Нет такого фильма: ${e}`,a.message),{id:null,poster_path:null}}};!async function e(){try{let t=await fetchMultiplePages("https://api.kinopoisk.dev/v1.4/movie?limit=250&page=PAGE&selectFields=externalId&selectFields=name&selectFields=year&selectFields=rating&selectFields=lists&sortField=rating.kp&sortType=-1&lists=top500",2),s=await Promise.all(t.map(async(e,t)=>{let{tmdb:s=null}=e.externalId||{},i=null;if(!s){let a=await fetchTmdbDataForMissingIds(e.name);s=a.id,i=a.poster_path}return{rank:t+1,id:s,title:e.name||null,release_date:e.year||"",vote_average:e.rating?.kp||null,poster_path:i}})),i=`https://api.kinopoisk.dev/v1.4/movie?limit=250&page=PAGE&selectFields=externalId&selectFields=name&selectFields=year&selectFields=rating&selectFields=top250&selectFields=votes&selectFields=isSeries&notNullFields=externalId.tmdb&seriesLength=!1&seriesLength=!2&seriesLength=!3&seriesLength=!4&seriesLength=!5&seriesLength=!6&seriesLength=!7&seriesLength=!8&seriesLength=!9&seriesLength=!10&seriesLength=!11&seriesLength=!12&seriesLength=!13&seriesLength=!14&genres.name=!детский&genres.name=!документальный&genres.name=!реальное ТВ&genres.name=!ток-шоу&genres.name=!игра&votes.kp=9999-9999999&votes.imdb=99-9999999&votes.imdb=0&sortField=top250&sortField=rating.kp&sortType=-1&sortType=-1&isSeries=true`,a=await fetchMultiplePages(i,2);a.sort((e,t)=>(e.top250??251)-(t.top250??251));let r=a.map((e,t)=>({rank:t+1,id:e.externalId?.tmdb||null,title:e.name||null,first_air_date:e.year||"",vote_average:e.rating?.kp||null}));await Promise.all([enrichWithTmdbPosters(s,!0),enrichWithTmdbPosters(r,!1)]);let[l,n]=await Promise.all([fetchCollectionCover("popular-films"),fetchCollectionCover("popular-series")]),o=new Date().toISOString().split("T")[0];fs.writeFileSync("data.json",JSON.stringify({date:o,movies:s,series:r,movies_cover:l,series_cover:n},null,2),"utf-8"),console.log("data.json обновлён!")}catch(c){console.error("Ошибка:",c),process.exit(1)}}();
